# Auto-Generated CLI Reference Docs

**Goal:** Use `generateHelp` from `src/kilocode/help.ts` to auto-generate CLI reference documentation, eliminating manual maintenance of the command table in `cli.md` and adding a full detailed reference page. The CLI code becomes the single source of truth for command names, descriptions, and options.

**Depends on:** `kilo help --all` feature (PR #571 / issue #560).

---

## Problem

`packages/kilo-docs/pages/code-with-ai/platforms/cli.md` lines 62-83 contain a hand-written command table. It is already stale — lists `kilo github` (disabled), missing `acp` and `help`. Every command add/remove/rename requires a manual docs update that is easy to forget.

---

## Design

Two generated artifacts, one source of truth:

1. **Quick reference table** — a Markdoc partial (`cli-commands-table.md`) included in the existing CLI docs page via `{% partial %}`. Replaces the hand-written table.
2. **Full CLI reference page** — a standalone page (`cli-reference.md`) with detailed help for every command and subcommand, generated by `generateHelp({ all: true, format: "md" })`.

Both are generated by `script/generate.ts` and auto-committed by the existing `generate.yml` workflow on push to `dev`.

---

## Codebase Orientation

- `script/generate.ts` — root-level generation script. Currently generates SDK only. Runs via `.github/workflows/generate.yml` on push to `dev`, auto-commits changes.
- `script/format.ts` — runs `prettier --write .` after generation.
- `packages/opencode/src/kilocode/help.ts` — existing `generateHelp()` function (from PR #571). Will gain a new `generateCommandTable()` export.
- `packages/kilo-docs/markdoc/partials/` — existing partials directory (contains `install-cli.md`, etc.).
- `packages/kilo-docs/pages/code-with-ai/platforms/cli.md` — CLI docs page with hand-written command table at lines 62-83. Already uses `{% partial file="install-cli.md" /%}`.
- `packages/kilo-docs/lib/nav/code-with-ai.ts` — nav config. Currently has `{ href: "/code-with-ai/platforms/cli", children: "CLI" }`.

---

## Testing Plan

Add tests to `packages/opencode/test/kilocode/help.test.ts`.

**Tests to write:**

1. `generateCommandTable()` returns a string containing a markdown table header (`| Command | Description |`).
2. Table contains rows for known commands (`run`, `auth`, `debug`, `mcp`).
3. Table does NOT contain `$0` — the default command appears as `kilo [project]`.
4. Table contains no ANSI escape sequences.
5. Table skips commands with no `describe` (like `GenerateCommand`).

---

## Task 1: Write failing tests for `generateCommandTable`

**Files:**

- Modify: `packages/opencode/test/kilocode/help.test.ts`

Add a new `describe("generateCommandTable", ...)` block importing `generateCommandTable` from `../../src/kilocode/help`. Tests will fail because the function doesn't exist yet.

**Verify failure:**

```bash
bun test test/kilocode/help.test.ts
```

---

## Task 2: Implement `generateCommandTable` in `src/kilocode/help.ts`

**Files:**

- Modify: `packages/opencode/src/kilocode/help.ts`

**Implementation:**

Export a new function:

```ts
export async function generateCommandTable(): Promise<string>
```

Logic:

1. Load commands from the barrel (same as `generateHelp`).
2. For each command, extract the command string and describe string.
3. For `$0 [project]` (TuiThreadCommand), output display name as `kilo [project]` with its describe.
4. Skip commands with no `describe` (e.g. `GenerateCommand`).
5. Add a `kilo completion` row manually at the end (registered via `.completion()`, not `.command()`, so it won't appear in the barrel).
6. Format command strings as inline code: `` `kilo run [message..]` ``.
7. Output a markdown table:

```markdown
| Command                | Description             |
| ---------------------- | ----------------------- |
| `kilo [project]`       | Start kilo tui          |
| `kilo run [message..]` | Run kilo with a message |
| `kilo auth`            | Manage credentials      |

...
| `kilo completion` | Generate shell completion script |
```

No yargs instance needed — reads `CommandModule.command` and `CommandModule.describe` directly.

**Run tests:**

```bash
bun test test/kilocode/help.test.ts
```

**Typecheck:**

```bash
bun run typecheck
```

---

## Task 3: Create the generation script for docs

**Files:**

- Create: `script/generate-cli-docs.ts`
- Modify: `script/generate.ts`

**Step 1: Create `script/generate-cli-docs.ts`**

A standalone bun script (`#!/usr/bin/env bun`) that:

1. Imports `generateHelp` and `generateCommandTable` from `packages/opencode/src/kilocode/help.ts`.
2. Generates the command table and writes it to `packages/kilo-docs/markdoc/partials/cli-commands-table.md`.
3. Generates the full reference with frontmatter and writes it to `packages/kilo-docs/pages/code-with-ai/platforms/cli-reference.md`.

The full reference page should have this structure:

```markdown
---
title: "CLI Command Reference"
description: "Complete reference for all Kilo CLI commands and subcommands"
---

# CLI Command Reference

<!-- Auto-generated by script/generate-cli-docs.ts — do not edit manually -->

{generated content from generateHelp({ all: true, format: "md" })}
```

The partial file:

```markdown
<!-- Auto-generated by script/generate-cli-docs.ts — do not edit manually -->

{generated table from generateCommandTable()}
```

**Step 2: Add to `script/generate.ts`**

Add one line before the format step:

```ts
await $`./script/generate-cli-docs.ts`
```

Generation order becomes:

1. SDK build
2. OpenAPI spec generation
3. CLI docs generation (new)
4. Prettier format (existing — formats the generated markdown)

**Step 3: Verify**

```bash
./script/generate-cli-docs.ts
cat packages/kilo-docs/markdoc/partials/cli-commands-table.md
head -30 packages/kilo-docs/pages/code-with-ai/platforms/cli-reference.md
```

---

## Task 4: Update the docs pages

**Files:**

- Modify: `packages/kilo-docs/pages/code-with-ai/platforms/cli.md`
- Modify: `packages/kilo-docs/lib/nav/code-with-ai.ts`

**Step 1: Replace the hand-written table in `cli.md`**

Replace the "### Top-Level CLI Commands" section and its table (lines 59-83) with:

```markdown
### Top-Level CLI Commands

{% partial file="cli-commands-table.md" /%}

For detailed help on every command and subcommand, see the [CLI Command Reference](/code-with-ai/platforms/cli-reference).
```

**Step 2: Add nav entry for the reference page**

In `packages/kilo-docs/lib/nav/code-with-ai.ts`, update the CLI entry:

```ts
{
  href: "/code-with-ai/platforms/cli",
  children: "CLI",
  subLinks: [
    { href: "/code-with-ai/platforms/cli-reference", children: "Command Reference" },
  ],
},
```

---

## Task 5: Final checks

**Step 1: Run full generation**

```bash
./script/generate.ts
```

Verify both files are generated and formatted.

**Step 2: Run tests**

```bash
bun test test/kilocode/help.test.ts
```

**Step 3: Typecheck**

```bash
bun turbo typecheck
```

**Step 4: Verify docs build**

```bash
bun run --filter @kilocode/kilo-docs build
```

---

## Implementation Details

- `generateCommandTable()` does NOT need a yargs instance — reads `CommandModule` fields directly, fast and side-effect-free.
- `generateHelp()` already handles the full reference. No changes to its core logic.
- The `generate.yml` workflow auto-commits — no CI changes needed. Adding/removing a command and merging to `dev` automatically updates the docs.
- `script/format.ts` runs prettier on the whole repo after generation, so generated markdown will be consistently formatted.
- Generated files have `<!-- Auto-generated ... do not edit manually -->` comments.
- The `help` command itself should appear in the full reference — it's a real user-facing command.
- `kilo completion` is manually added to the table since it's registered via `.completion()` not `.command()`.
