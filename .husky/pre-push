#!/usr/bin/env sh

# Add node_modules/.bin to PATH for local binaries
# Use git to find repository root reliably
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || echo "$(dirname -- "$0")/../..")"
if [ -d "$REPO_ROOT/node_modules/.bin" ]; then
    export PATH="$REPO_ROOT/node_modules/.bin:$PATH"
fi

# kilocode_change - optimized pre-push hook with memory limits and timeout

branch="$(git rev-parse --abbrev-ref HEAD)"

if [ "$branch" = "main" ]; then
  echo "You can't push directly to main - please check out a branch."
  exit 1
fi

# Set memory limits to prevent excessive resource usage
export NODE_OPTIONS="${NODE_OPTIONS:-} --max-old-space-size=3072 --max-semi-space-size=256"

# Detect if running on Windows and use pnpm.cmd, otherwise use pnpm.
if [ "$OS" = "Windows_NT" ]; then
  pnpm_cmd="pnpm.cmd"
else
  if command -v pnpm >/dev/null 2>&1; then
    pnpm_cmd="pnpm"
  else
    pnpm_cmd="npx pnpm"
  fi
fi

# Add timeout to prevent infinite hanging (5 minutes)
echo "üîç Running optimized type checks..."
timeout 300 $pnpm_cmd run check-types || {
  echo "‚ùå Type check timed out or failed"
  exit 1
}

# Use dotenvx to securely load .env.local and run commands that depend on it
if [ -f ".env.local" ]; then
  # Check if RUN_TESTS_ON_PUSH is set to true and run tests with dotenvx
  if npx dotenvx get RUN_TESTS_ON_PUSH -f .env.local 2>/dev/null | grep -q "^true$"; then
    echo "üß™ Running tests with optimized settings..."
    timeout 600 npx dotenvx run -f .env.local -- $pnpm_cmd run test || {
      echo "‚ùå Tests timed out or failed"
      exit 1
    }
  fi
else
  # Fallback: run tests if RUN_TESTS_ON_PUSH is set in regular environment
  if [ "$RUN_TESTS_ON_PUSH" = "true" ]; then
    echo "üß™ Running tests with optimized settings..."
    timeout 600 $pnpm_cmd run test || {
      echo "‚ùå Tests timed out or failed"
      exit 1
    }
  fi
fi

# Check for new changesets.
NEW_CHANGESETS=$(find .changeset -name "*.md" ! -name "README.md" | wc -l | tr -d ' ')
echo "Changeset files: $NEW_CHANGESETS"

if [ "$NEW_CHANGESETS" = "0" ]; then
  echo "-------------------------------------------------------------------------------------"
  echo "Changes detected. Please run 'pnpm changeset' to create a changeset if applicable."
  echo "-------------------------------------------------------------------------------------"
fi
