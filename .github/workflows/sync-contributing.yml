# kilocode_change - new file
name: sync-contributing

on:
  push:
    branches:
      - dev
    paths:
      - .github/ISSUE_TEMPLATE/**
      - .github/workflows/duplicate-issues.yml
      - .github/workflows/compliance-close.yml
      - .github/workflows/stale-issues.yml
      - .github/workflows/close-stale-prs.yml
      - .github/workflows/pr-standards.yml
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: ./.github/actions/setup-bun

      - name: Setup Git Committer
        id: committer
        uses: ./.github/actions/setup-git-committer
        with:
          kilo-maintainer-app-id: ${{ secrets.KILO_MAINTAINER_APP_ID }}
          kilo-maintainer-app-secret: ${{ secrets.KILO_MAINTAINER_APP_SECRET }}

      - name: Setup Kilo
        uses: ./.github/actions/setup-kilo

      - name: Extract contributing facts
        run: bun .github/scripts/extract-contributing-facts.ts --output contributing-facts.json

      - name: Update CONTRIBUTING.md via Kilo
        env:
          KILO_API_KEY: ${{ secrets.KILO_API_KEY }}
          KILO_ORG_ID: ${{ secrets.KILO_ORG_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          KILO_PERMISSION: |
            {
              "write_file": { "*": "allow" },
              "bash": { "*": "deny" },
              "webfetch": "deny"
            }
        run: |
          FACTS=$(cat contributing-facts.json)
          kilo run -m "kilo/anthropic/claude-sonnet-4-5" \
            "Read the file contributing-facts.json which contains structured facts extracted from the GitHub issue templates and workflow files. Then update CONTRIBUTING.md to ensure these sections accurately reflect the facts:
          - 'Opening Issues' section: blank issues policy, template names, compliance rules, auto-close window
          - 'Reporting Bugs' section: required and recommended fields
          - 'Requesting Features' section: required checkbox text, title prefix, required fields
          - 'Stale Issues and PRs' section: exact day counts for stale/close
          - 'PR Titles' section: exact list of valid prefixes

          Preserve all other sections of CONTRIBUTING.md exactly as they are. Only update the data-driven sections listed above. Do not add new sections or remove existing ones."

      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet CONTRIBUTING.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: No changes needed
        if: steps.diff.outputs.changed == 'false'
        run: echo "CONTRIBUTING.md is already up to date"

      - name: Create PR with updated CONTRIBUTING.md
        if: steps.diff.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ steps.committer.outputs.token }}
        run: |
          BRANCH="docs/sync-contributing-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git add CONTRIBUTING.md
          git commit -m "docs: sync CONTRIBUTING.md with issue templates and workflow changes"
          git push origin "$BRANCH"
          gh pr create \
            --title "docs: sync CONTRIBUTING.md with issue templates and workflow changes" \
            --body "## Automated CONTRIBUTING.md sync

          This PR was automatically generated by the \`sync-contributing\` workflow because one or more source-of-truth files changed on the \`dev\` branch.

          **Changed source files that triggered this sync:**
          $(git diff --name-only HEAD~1 HEAD -- \
              .github/ISSUE_TEMPLATE/ \
              .github/workflows/duplicate-issues.yml \
              .github/workflows/compliance-close.yml \
              .github/workflows/stale-issues.yml \
              .github/workflows/close-stale-prs.yml \
              .github/workflows/pr-standards.yml \
            2>/dev/null | sed 's/^/- /' || echo '- (workflow_dispatch or unknown)')

          **What was updated:**
          The AI agent read \`contributing-facts.json\` (extracted from the source files above) and updated only the data-driven sections of \`CONTRIBUTING.md\`:
          - Opening Issues section (template names, compliance rules, auto-close window)
          - Reporting Bugs section (required/optional fields)
          - Requesting Features section (required checkbox, title prefix)
          - Stale Issues and PRs section (day counts)
          - PR Titles section (valid prefixes)

          Please review the diff and merge if correct. This PR uses the \`docs:\` prefix and is exempt from the linked-issue requirement." \
            --base dev \
            --head "$BRANCH"
